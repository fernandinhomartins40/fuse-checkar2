// Prisma Schema para Fuse Checkar2
// Sistema de Gestão de Revisões Automotivas

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

// ============================================================================
// ENUMS
// ============================================================================

enum Role {
  CLIENTE
  MECANICO
  ADMIN
}

enum StatusCliente {
  ATIVO
  INATIVO
  BLOQUEADO
  PENDENTE
}

enum StatusRevisao {
  AGENDADA
  EM_ANDAMENTO
  CONCLUIDA
  CANCELADA
}

enum Prioridade {
  ALTA
  MEDIA
  BAIXA
}

enum StatusRecomendacao {
  PENDENTE
  ACEITA
  RECUSADA
  IMPLEMENTADA
}

enum TipoRevisao {
  PREVENTIVA
  CORRETIVA
  PERIODICA
  EMERGENCIAL
}

enum StatusVeiculo {
  ATIVO
  INATIVO
  EM_MANUTENCAO
  VENDIDO
}

// ============================================================================
// MODELS - AUTENTICAÇÃO E USUÁRIOS
// ============================================================================

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  senha     String   @db.VarChar(255)
  role      Role     @default(CLIENTE)
  isActive  Boolean  @default(true)

  // Tokens
  refreshToken String? @db.VarChar(500)
  resetToken   String? @db.VarChar(255)
  resetTokenExpiry DateTime?

  // Email verification
  emailVerified Boolean @default(false)
  verificationToken String? @db.VarChar(255)

  // Timestamps
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relações
  cliente   Cliente?
  mecanico  Mecanico?
  admin     Admin?

  @@index([email])
  @@index([role])
  @@map("users")
}

model Admin {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  nome      String   @db.VarChar(255)
  cpf       String   @unique @db.VarChar(14)
  telefone  String   @db.VarChar(20)

  // Permissões
  permissions Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cpf])
  @@map("admins")
}

// ============================================================================
// MODELS - CLIENTES
// ============================================================================

model Cliente {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Informações Pessoais
  nome           String   @db.VarChar(100)
  sobrenome      String   @db.VarChar(100)
  cpf            String   @unique @db.VarChar(14)
  rg             String?  @db.VarChar(20)
  dataNascimento DateTime? @db.Date
  profissao      String?  @db.VarChar(100)

  // Informações de Contato
  email          String   @unique @db.VarChar(255)
  telefone       String   @db.VarChar(20)
  telefone2      String?  @db.VarChar(20)
  whatsapp       String?  @db.VarChar(20)

  // Endereço
  cep            String?  @db.VarChar(10)
  endereco       String?  @db.VarChar(255)
  numero         String?  @db.VarChar(20)
  complemento    String?  @db.VarChar(100)
  bairro         String?  @db.VarChar(100)
  cidade         String?  @db.VarChar(100)
  estado         String?  @db.VarChar(2)
  pais           String   @default("Brasil") @db.VarChar(50)

  // Status e Configurações
  status         StatusCliente @default(ATIVO)

  // Preferências
  notificacoesEmail Boolean @default(true)
  notificacoesSms   Boolean @default(false)
  newsletter        Boolean @default(true)

  // Metadados
  lastVisit      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relações
  veiculos       Veiculo[]
  revisoes       Revisao[]
  recomendacoes  Recomendacao[]

  @@index([cpf])
  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("clientes")
}

// ============================================================================
// MODELS - MECÂNICOS
// ============================================================================

model Mecanico {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  nome           String   @db.VarChar(100)
  sobrenome      String   @db.VarChar(100)
  cpf            String   @unique @db.VarChar(14)
  telefone       String   @db.VarChar(20)

  // Informações Profissionais
  especialidade  String?  @db.VarChar(100)
  registro       String?  @db.VarChar(50)

  isActive       Boolean  @default(true)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relações
  revisoes       Revisao[]

  @@index([cpf])
  @@index([isActive])
  @@map("mecanicos")
}

// ============================================================================
// MODELS - VEÍCULOS
// ============================================================================

model Veiculo {
  id             Int      @id @default(autoincrement())
  clienteId      Int
  cliente        Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  // Informações do Veículo
  marca          String   @db.VarChar(50)
  modelo         String   @db.VarChar(100)
  ano            Int
  anoModelo      Int?
  placa          String   @unique @db.VarChar(10)
  cor            String?  @db.VarChar(30)
  chassi         String?  @unique @db.VarChar(30)
  renavam        String?  @unique @db.VarChar(20)

  // Dados Técnicos
  motor          String?  @db.VarChar(50)
  combustivel    String?  @db.VarChar(20)
  cambio         String?  @db.VarChar(20)

  // Quilometragem
  kmAtual        Int?
  kmUltimaRevisao Int?

  // Status
  status         StatusVeiculo @default(ATIVO)

  // Observações
  observacoes    String?  @db.Text

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relações
  revisoes       Revisao[]
  recomendacoes  Recomendacao[]

  @@index([clienteId])
  @@index([placa])
  @@index([status])
  @@map("veiculos")
}

// ============================================================================
// MODELS - REVISÕES
// ============================================================================

model Revisao {
  id             Int      @id @default(autoincrement())

  // Relações
  clienteId      Int
  cliente        Cliente  @relation(fields: [clienteId], references: [id])

  veiculoId      Int
  veiculo        Veiculo  @relation(fields: [veiculoId], references: [id])

  mecanicoId     Int?
  mecanico       Mecanico? @relation(fields: [mecanicoId], references: [id], onDelete: SetNull)

  // Informações da Revisão
  tipo           TipoRevisao
  status         StatusRevisao @default(AGENDADA)

  // Datas
  dataAgendamento DateTime
  dataRevisao    DateTime
  dataInicio     DateTime?
  dataConclusao  DateTime?

  // Quilometragem
  kmAtual        Int?
  kmProxima      Int?

  // Checklist (JSON com itens verificados)
  checklist      Json?

  // Serviços Realizados
  servicosRealizados Json?

  // Peças Substituídas
  pecasSubstituidas Json?

  // Valores
  valorServico   Decimal?  @db.Decimal(10, 2)
  valorPecas     Decimal?  @db.Decimal(10, 2)
  valorTotal     Decimal?  @db.Decimal(10, 2)

  // Observações
  observacoes    String?   @db.Text
  diagnostico    String?   @db.Text

  // Garantia
  garantiaDias   Int?
  garantiaKm     Int?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([clienteId])
  @@index([veiculoId])
  @@index([mecanicoId])
  @@index([status])
  @@index([dataRevisao])
  @@map("revisoes")
}

// ============================================================================
// MODELS - RECOMENDAÇÕES
// ============================================================================

model Recomendacao {
  id             Int      @id @default(autoincrement())

  // Relações
  clienteId      Int
  cliente        Cliente  @relation(fields: [clienteId], references: [id])

  veiculoId      Int
  veiculo        Veiculo  @relation(fields: [veiculoId], references: [id])

  // Informações da Recomendação
  titulo         String   @db.VarChar(200)
  descricao      String   @db.Text
  prioridade     Prioridade @default(MEDIA)
  status         StatusRecomendacao @default(PENDENTE)

  // Estimativas
  valorEstimado  Decimal? @db.Decimal(10, 2)
  prazoEstimado  Int?

  // Categoria
  categoria      String?  @db.VarChar(50)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([clienteId])
  @@index([veiculoId])
  @@index([status])
  @@index([prioridade])
  @@map("recomendacoes")
}

// ============================================================================
// MODELS - UPLOADS/DOCUMENTOS
// ============================================================================

model Upload {
  id             Int      @id @default(autoincrement())

  // Arquivo
  filename       String   @db.VarChar(255)
  originalName   String   @db.VarChar(255)
  path           String   @db.VarChar(500)
  mimetype       String   @db.VarChar(100)
  size           Int

  // Tipo
  type           String   @db.VarChar(50)

  // Relações polimórficas
  relatedTo      String?  @db.VarChar(50)
  relatedId      Int?

  // Upload info
  uploadedBy     Int?

  createdAt      DateTime @default(now())

  @@index([relatedTo, relatedId])
  @@map("uploads")
}

// ============================================================================
// MODELS - AUDITORIA
// ============================================================================

model AuditLog {
  id             Int      @id @default(autoincrement())

  // Usuário que fez a ação
  userId         Int?
  userEmail      String?  @db.VarChar(255)
  userRole       Role?

  // Ação
  action         String   @db.VarChar(50)
  entity         String   @db.VarChar(50)
  entityId       Int?

  // Dados
  oldData        Json?
  newData        Json?

  // Request info
  ip             String?  @db.VarChar(45)
  userAgent      String?  @db.VarChar(500)

  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
