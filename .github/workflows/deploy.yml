name: ğŸš€ Deploy Fuse Checkar2

# Controle de concorrÃªncia
concurrency:
  group: fuse-checkar2-deploy
  cancel-in-progress: true

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      full_reinstall:
        description: 'ReinstalaÃ§Ã£o completa (true/false)'
        required: false
        default: 'false'

env:
  VPS_HOST: '31.97.85.98'
  VPS_USER: 'root'
  DEPLOY_DIR: '/opt/fuse-checkar2'
  APP_NAME: 'fuse-checkar2'

jobs:
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ğŸ“‹ InformaÃ§Ãµes do Deploy
      run: |
        echo "ğŸš€ DEPLOY FUSE CHECKAR2"
        echo "====================="
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "ReinstalaÃ§Ã£o completa: ${{ github.event.inputs.full_reinstall || 'false' }}"
        echo "VPS: ${{ env.VPS_HOST }}"
        echo "====================="

    - name: ğŸ”‘ Configurar SSH
      run: |
        echo "ğŸ”‘ Configurando SSH..."
        sudo apt-get update && sudo apt-get install -y sshpass
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

    - name: ğŸ” Verificar Estado da VPS
      id: vps-check
      run: |
        echo "ğŸ” Verificando estado da VPS..."
        
        NEEDS_INSTALL="false"
        APP_RUNNING="false"
        
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          echo '=== Verificando Sistema ==='
          
          # Verificar dependÃªncias crÃ­ticas
          MISSING=''
          if ! command -v docker >/dev/null 2>&1; then
            echo 'âŒ Docker: NÃƒO INSTALADO'
            MISSING=\"docker \$MISSING\"
          else
            echo \"âœ… Docker: \$(docker --version | cut -d' ' -f1-3)\"
          fi
          
          if ! command -v docker-compose >/dev/null 2>&1 && ! docker compose version >/dev/null 2>&1; then
            echo 'âŒ Docker Compose: NÃƒO INSTALADO'
            MISSING=\"compose \$MISSING\"
          else
            echo 'âœ… Docker Compose: INSTALADO'
          fi
          
          if ! command -v nginx >/dev/null 2>&1; then
            echo 'âŒ Nginx: NÃƒO INSTALADO'
            MISSING=\"nginx \$MISSING\"
          else
            echo 'âœ… Nginx: INSTALADO'
          fi
          
          # Verificar diretÃ³rio e aplicaÃ§Ã£o
          if [ ! -d '${{ env.DEPLOY_DIR }}' ]; then
            echo 'âŒ DiretÃ³rio da aplicaÃ§Ã£o: NÃƒO EXISTE'
            MISSING=\"dir \$MISSING\"
          else
            echo 'âœ… DiretÃ³rio da aplicaÃ§Ã£o: EXISTE'
            
            # Verificar se container estÃ¡ rodando
            if docker ps | grep -q '${{ env.APP_NAME }}-app'; then
              echo 'âœ… Container: RODANDO'
              APP_RUNNING='true'
            else
              echo 'âŒ Container: NÃƒO RODANDO'
            fi
            
            # Verificar se imagem existe
            if docker images | grep -q '${{ env.APP_NAME }}'; then
              echo 'âœ… Imagem Docker: EXISTE'
            else
              echo 'âŒ Imagem Docker: NÃƒO EXISTE'
              MISSING=\"image \$MISSING\"
            fi
          fi
          
          if [ -n \"\$MISSING\" ]; then
            echo \"NEEDS_INSTALL=true\" > /tmp/deploy_status.txt
          else
            echo \"NEEDS_INSTALL=false\" > /tmp/deploy_status.txt
          fi
          
          echo \"APP_RUNNING=\$APP_RUNNING\" >> /tmp/deploy_status.txt
          echo \"MISSING=\$MISSING\" >> /tmp/deploy_status.txt
        "
        
        # Capturar resultados
        NEEDS_INSTALL=$(sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "grep NEEDS_INSTALL /tmp/deploy_status.txt | cut -d'=' -f2" 2>/dev/null || echo "true")
        APP_RUNNING=$(sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "grep APP_RUNNING /tmp/deploy_status.txt | cut -d'=' -f2" 2>/dev/null || echo "false")
        
        echo "needs_install=$NEEDS_INSTALL" >> $GITHUB_OUTPUT
        echo "app_running=$APP_RUNNING" >> $GITHUB_OUTPUT
        
        echo "ğŸ Precisa instalaÃ§Ã£o: $NEEDS_INSTALL"
        echo "ğŸ App rodando: $APP_RUNNING"

    - name: ğŸ› ï¸ InstalaÃ§Ã£o do Sistema (se necessÃ¡ria)
      if: steps.vps-check.outputs.needs_install == 'true' || github.event.inputs.full_reinstall == 'true'
      run: |
        echo "ğŸ› ï¸ Instalando dependÃªncias do sistema..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          set -e
          export DEBIAN_FRONTEND=noninteractive
          
          # FunÃ§Ã£o para aguardar liberaÃ§Ã£o do apt lock
          wait_for_apt_lock() {
            echo 'â³ Aguardando liberaÃ§Ã£o do apt lock...'
            local max_attempts=30
            local attempt=1
            
            while [ \$attempt -le \$max_attempts ]; do
              if ! lsof /var/lib/dpkg/lock-frontend >/dev/null 2>&1 && ! pgrep -x unattended-upgr >/dev/null 2>&1; then
                echo 'âœ… Apt lock liberado!'
                return 0
              fi
              
              echo \"Tentativa \$attempt/\$max_attempts - Aguardando unattended-upgrades terminar...\"
              sleep 10
              attempt=\$((attempt + 1))
            done
            
            echo 'âš ï¸ Timeout aguardando apt lock - forÃ§ando liberaÃ§Ã£o...'
            systemctl stop unattended-upgrades.service || true
            killall unattended-upgr 2>/dev/null || true
            rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock || true
            dpkg --configure -a || true
            return 0
          }
          
          # Aguardar liberaÃ§Ã£o do lock antes de continuar
          wait_for_apt_lock
          
          echo 'ğŸ“¦ Atualizando sistema...'
          apt-get update -y
          apt-get install -y curl wget gnupg2 software-properties-common build-essential jq htop ufw git
          
          # Docker
          if ! command -v docker >/dev/null 2>&1; then
            echo 'ğŸ³ Instalando Docker...'
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
            systemctl start docker
            systemctl enable docker
            rm get-docker.sh
            
            # Adicionar usuÃ¡rio ao grupo docker (se nÃ£o for root)
            usermod -aG docker root || true
          fi
          
          # Docker Compose
          if ! command -v docker-compose >/dev/null 2>&1 && ! docker compose version >/dev/null 2>&1; then
            echo 'ğŸ³ Instalando Docker Compose...'
            curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
          fi
          
          # Nginx
          if ! command -v nginx >/dev/null 2>&1; then
            echo 'ğŸŒ Instalando Nginx...'
            wait_for_apt_lock
            apt-get install -y nginx
            systemctl start nginx
            systemctl enable nginx
          fi
          
          # Firewall bÃ¡sico
          ufw --force enable
          ufw allow ssh
          ufw allow 80
          ufw allow 443
          
          echo 'âœ… Sistema configurado!'
        "

    - name: ğŸ”„ Atualizar CÃ³digo
      run: |
        echo "ğŸ”„ Atualizando cÃ³digo da aplicaÃ§Ã£o..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          # Criar diretÃ³rio se nÃ£o existe
          mkdir -p ${{ env.DEPLOY_DIR }}
          cd ${{ env.DEPLOY_DIR }}
          
          # Clone ou pull
          if [ ! -d .git ]; then
            echo 'ğŸ†• Clonando repositÃ³rio...'
            git clone https://github.com/SEU_USUARIO/fuse-checkar2.git .
          else
            echo 'ğŸ“¥ Atualizando repositÃ³rio...'
            git fetch origin
            git reset --hard origin/main
            git pull origin main
          fi
          
          # Verificar arquivos crÃ­ticos
          echo 'ğŸ” Verificando arquivos crÃ­ticos...'
          if [ -f 'index.html' ]; then
            echo 'âœ… index.html encontrado'
          else
            echo 'âŒ index.html nÃ£o encontrado!'
          fi
          
          if [ -f 'backend/src/server.js' ]; then
            echo 'âœ… backend/src/server.js encontrado'
          else
            echo 'âŒ backend/src/server.js nÃ£o encontrado!'
          fi
          
          if [ -f 'package.json' ]; then
            echo 'âœ… package.json encontrado'
          else
            echo 'âŒ package.json nÃ£o encontrado!'
          fi
        "

    - name: ğŸ³ Build e Deploy com Docker
      run: |
        echo "ğŸ³ Build e deploy da aplicaÃ§Ã£o com Docker..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}
          
          echo 'ğŸ—ï¸ Parando containers existentes...'
          docker-compose down --remove-orphans || docker compose down --remove-orphans || true
          
          echo 'ğŸ§¹ Limpando imagens antigas...'
          docker image prune -f
          
          echo 'ğŸ—ï¸ Construindo nova imagem Docker...'
          docker-compose build --no-cache fuse-checkar2 || docker compose build --no-cache fuse-checkar2
          
          if [ \$? -eq 0 ]; then
            echo 'âœ… Build da imagem Docker concluÃ­do'
            docker images | grep fuse-checkar2
          else
            echo 'âŒ Erro no build da imagem Docker!'
            exit 1
          fi
          
          echo 'ğŸ“ Criando diretÃ³rios necessÃ¡rios...'
          mkdir -p logs data
          chmod 755 logs data
        "

    - name: ğŸŒ Configurar Nginx
      run: |
        echo "ğŸŒ Configurando Nginx..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} '
          echo "ğŸŒ Criando configuraÃ§Ã£o do Nginx..."
          
          # Criar configuraÃ§Ã£o do Nginx
          cat > /etc/nginx/sites-available/fuse-checkar2 << EOF
server {
    listen 80;
    server_name 31.97.85.98 _;
    
    # Servir aplicaÃ§Ã£o React+Express via Docker
    location / {
        proxy_pass http://127.0.0.1:3005;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # Headers especÃ­ficos para Docker
        proxy_set_header X-Forwarded-Host \$host;
        proxy_set_header X-Forwarded-Server \$host;
    }
    
    # Health check
    location /health {
        access_log off;
        return 200 "healthy";
        add_header Content-Type text/plain;
    }
}
EOF
          
          # Habilitar site e remover default
          ln -sf /etc/nginx/sites-available/fuse-checkar2 /etc/nginx/sites-enabled/
          rm -f /etc/nginx/sites-enabled/default
          
          # Testar configuraÃ§Ã£o
          if /usr/sbin/nginx -t; then
            echo "âœ… ConfiguraÃ§Ã£o do Nginx vÃ¡lida"
            systemctl reload nginx || systemctl restart nginx
            echo "âœ… Nginx reconfigurado"
          else
            echo "âŒ Erro na configuraÃ§Ã£o do Nginx"
            /usr/sbin/nginx -t
            exit 1
          fi
        '

    - name: ğŸš€ Iniciar AplicaÃ§Ã£o com Docker
      run: |
        echo "ğŸš€ Iniciando aplicaÃ§Ã£o com Docker..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}
          
          echo 'ğŸ³ Iniciando containers...'
          docker-compose up -d fuse-checkar2 || docker compose up -d fuse-checkar2
          
          echo 'â³ Aguardando inicializaÃ§Ã£o...'
          sleep 20
          
          # Verificar se container estÃ¡ rodando
          if docker ps | grep -q '${{ env.APP_NAME }}-app.*Up'; then
            echo 'âœ… Container iniciado com sucesso'
            docker ps | grep '${{ env.APP_NAME }}-app'
            
            echo 'ğŸ“‹ Status do container:'
            docker-compose ps fuse-checkar2 || docker compose ps fuse-checkar2
            
            echo 'ğŸ“‹ Logs da aplicaÃ§Ã£o:'
            docker-compose logs --tail=20 fuse-checkar2 || docker compose logs --tail=20 fuse-checkar2
          else
            echo 'âŒ Container nÃ£o ficou online'
            echo 'ğŸ“‹ Containers ativos:'
            docker ps -a
            echo 'ğŸ“‹ Logs completos:'
            docker-compose logs fuse-checkar2 || docker compose logs fuse-checkar2
            exit 1
          fi
          
          echo 'ğŸ” Verificando health check...'
          for i in {1..6}; do
            if docker exec ${{ env.APP_NAME }}-app wget -q --spider http://localhost:3005/api/health; then
              echo 'âœ… Health check passou'
              break
            else
              echo \"â³ Health check tentativa \$i/6...\"
              sleep 10
            fi
            
            if [ \$i -eq 6 ]; then
              echo 'âŒ Health check falhou apÃ³s 60 segundos'
              docker-compose logs --tail=50 fuse-checkar2 || docker compose logs --tail=50 fuse-checkar2
              exit 1
            fi
          done
        "

    - name: ğŸ” VerificaÃ§Ã£o Final
      run: |
        echo "ğŸ” VerificaÃ§Ã£o final do deploy..."
        sshpass -p '${{ secrets.VPS_PASSWORD }}' ssh -o StrictHostKeyChecking=no ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
          cd ${{ env.DEPLOY_DIR }}
          
          echo '=== Status dos Containers ==='
          docker-compose ps || docker compose ps
          
          echo ''
          echo '=== InformaÃ§Ãµes do Container ==='
          docker inspect ${{ env.APP_NAME }}-app --format='{{.State.Status}}' 2>/dev/null || echo 'Container nÃ£o encontrado'
          
          echo ''
          echo '=== Teste de Conectividade ==='
          for i in {1..5}; do
            if curl -f -s http://localhost:3005/api/health >/dev/null 2>&1; then
              echo 'âœ… API responde na porta 3005'
              curl -s http://localhost:3005/api/health
              break
            else
              echo \"â³ Tentativa \$i/5...\"
              sleep 3
            fi
            
            if [ \$i -eq 5 ]; then
              echo 'âŒ API nÃ£o responde apÃ³s 15 segundos'
              docker-compose logs --tail=30 fuse-checkar2 || docker compose logs --tail=30 fuse-checkar2
            fi
          done
          
          echo ''
          echo '=== Teste via Nginx ==='
          echo 'ğŸ” Testando Nginx diretamente...'
          if curl -f -s http://localhost/ >/dev/null 2>&1; then
            echo 'âœ… Nginx proxy funcionando'
            echo 'ğŸ“‹ Resposta do Nginx:'
            curl -s http://localhost/ | head -5
          else
            echo 'âŒ Problema no Nginx proxy'
            echo 'ğŸ“‹ Status do Nginx:'
            systemctl status nginx --no-pager -l || true
            echo 'ğŸ“‹ Logs do Nginx:'
            tail -10 /var/log/nginx/error.log 2>/dev/null || echo 'Sem logs de erro'
          fi
          
          echo ''
          echo '=== Recursos Docker ==='
          echo \"Imagem Docker: \$(docker images | grep '${{ env.APP_NAME }}' >/dev/null && echo 'âœ… OK' || echo 'âŒ MISSING')\"
          echo \"Container: \$(docker ps | grep '${{ env.APP_NAME }}-app' | grep -q Up && echo 'âœ… RUNNING' || echo 'âŒ STOPPED')\"
          echo \"Docker Compose: \$([ -f '${{ env.DEPLOY_DIR }}/docker-compose.yml' ] && echo 'âœ… OK' || echo 'âŒ MISSING')\"
          echo \"Dockerfile: \$([ -f '${{ env.DEPLOY_DIR }}/Dockerfile' ] && echo 'âœ… OK' || echo 'âŒ MISSING')\"
          
          echo ''
          echo '=== Uso de Recursos ==='
          if docker stats --no-stream --format 'table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}' | grep -q '${{ env.APP_NAME }}-app'; then
            docker stats --no-stream --format 'table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}' | grep '${{ env.APP_NAME }}-app'
          else
            echo 'EstatÃ­sticas nÃ£o disponÃ­veis'
          fi
        "

    - name: ğŸ“Š RelatÃ³rio Final
      if: always()
      run: |
        echo "ğŸ“Š RELATÃ“RIO DO DEPLOY"
        echo "====================="
        echo "AplicaÃ§Ã£o: Fuse Checkar2"
        echo "Commit: ${{ github.sha }}"
        echo "Timestamp: $(date)"
        echo "VPS: ${{ env.VPS_HOST }}"
        echo ""
        echo "ğŸ¯ AplicaÃ§Ã£o: http://${{ env.VPS_HOST }}/"
        echo "ğŸ”§ API Health: http://${{ env.VPS_HOST }}/api/health"
        echo ""
        echo "âœ… Deploy concluÃ­do!"

    - name: ğŸ‰ Deploy ConcluÃ­do
      run: |
        echo "ğŸ‰ DEPLOY FUSE CHECKAR2 REALIZADO COM SUCESSO!"
        echo "ğŸš€ Sistema: FUNCIONANDO"
        echo "ğŸ’» Frontend: React + Vite"
        echo "âš™ï¸ Backend: Node.js + Express"
        echo "ğŸŒ Proxy: Nginx"
        echo ""
        echo "Acesse: http://${{ env.VPS_HOST }}/"